#!/bin/sh


help(){
    echo "
    Usage: $(basename $0)

    Autogenerate debian changelog entry from the current git repository.
    "
}

[ "$1" = "--help" -o "$1" = "-h" ] && help && exit 0

set -eu

if [ ! -d debian ]; then
    echo "Cannot find debian directory from cwd ($(pwd)/debian)"
    exit 1
fi

assert_git_repo()
{
    git rev-parse --git-dir 2>&1 >/dev/null
}

assert_git_repo || {
    echo "E: not a git repository, aborting" >&2
    exit 1
}

if [ -z "${DEBFULLNAME:-}" ]; then
    DEBFULLNAME="Opinsys Developers"
fi

if [ -z "${DEBEMAIL:-}" ]; then
    DEBEMAIL="dev@opinsys.fi"
fi

# Get ubuntu version to $DISTRIB_CODENAME
. /etc/lsb-release

package_dir=$(pwd)
repo_name=$(basename $(pwd))

# List tags by date and grab last
# http://stackoverflow.com/questions/6269927/how-can-i-list-all-tags-in-my-git-repository-by-the-date-they-were-created
prev_version=$(git for-each-ref --sort='*authordate' --format='%(refname:short)' refs/tags  | tail --lines=1)
git_branch=$(git rev-parse --abbrev-ref HEAD)
git_commit=$(git rev-parse HEAD)

version="${prev_version}.dev$(date +%s).jenkins.$git_branch.$git_commit"

cd $package_dir
cat > debian/changelog.new <<EOF
$repo_name ($version-0+opinsys1) $DISTRIB_CODENAME; urgency=low

  * https://github.com/opinsys/$repo_name/compare/${prev_version}...${git_commit}

 -- $DEBFULLNAME <$DEBEMAIL>  $(date -R)

EOF
cat debian/changelog.new
cat debian/changelog >> debian/changelog.new
mv debian/changelog.new debian/changelog
