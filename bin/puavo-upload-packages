#!/bin/sh

help(){
    echo "
    Usage: $(basename $0) <debbox url> <.changes file> [aptirepo branch]

    https://github.com/opinsys/debbox
    "

}

[ "$1" = "--help" -o "$1" = "-h" ] && help && exit 0
[ "$1" = "" -o "$2" = "" ] && help && exit 1

debbox_url="$1"
changes_file="$2"
aptirepo_branch="$3"
curl_args=""

set -eu

. /usr/lib/aptirepo/common.sh

if [ "$aptirepo_branch" != "" ]; then
    curl_args="$curl_args -F branch=$aptirepo_branch"
fi

cd $(dirname $changes_file)
changes_file="$(basename "$changes_file")"

curl_args="$curl_args -F changes=@$(basename $changes_file)"

for filename in $(parse_multiline "$changes_file" Files | cut -d " " -f 5)
do
    curl_args="$curl_args -F file=@${filename}"
done

echo $curl_args

set -x
curl --fail -v $curl_args $debbox_url
