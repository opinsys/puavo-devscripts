#!/bin/sh

help(){
    echo "
    Usage: $(basename $0)

    Get debian directory as symbolic link for the current project.

    When executed in a project directory root this script will create a
    'debian' symlink pointing to

    ../opinsys-debs/packages/<UBUNTU RELEASE CODE NAME>/<PROJECT NAME>/debian

    If ../opinsys-debs does not exist it will be automatically cloned from
    https://github.com/opinsys/opinsys-debs.git
    "

}

[ "$1" = "--help" -o "$1" = "-h" ] && help && exit 0

set -eu

# Get ubuntu version to $DISTRIB_CODENAME
. /etc/lsb-release

assert_git_repo() {
    git rev-parse --git-dir 2>&1 >/dev/null
}

assert_git_repo || {
    echo "E: not a git repository, aborting" >&2
    exit 1
}


# Remove previous symbolic link if any
if [ -h debian ]; then
    rm debian
fi

if [ -d debian ]; then
    echo "Cannot get debian dir. Already exists and is a directory."
    exit 1
fi

repo_dir=$(pwd)
repo_name=$(basename $repo_dir)
opinsysdebs_location="../opinsys-debs"

if [ ! -d $opinsysdebs_location ]; then
    git clone https://github.com/opinsys/opinsys-debs.git $opinsysdebs_location
fi

debian_dir=""
for dist_code in $DISTRIB_CODENAME default; do
    debian_dir_tmp="$opinsysdebs_location/packages/$dist_code/$repo_name/debian"
    echo "Testing $debian_dir_tmp"
    if [ -d $debian_dir_tmp ]; then
        debian_dir=$debian_dir_tmp
        break
    fi
done

if [ $debian_dir = "" ]; then
    echo "Failed find debian directory for you :("
    exit 1
fi

ln -s $debian_dir debian

