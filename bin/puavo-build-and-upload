#!/bin/sh

help(){
    echo "
    Usage: $(basename $0) <DEBBOX URL>

    Build and publish debian native package to given debbox url.

    https://github.com/opinsys/debbox
    "

}

[ "$1" = "--help" -o "$1" = "-h" ] && help && exit 0
[ "$1" = "" ] && help && exit 1

set -eu

debbox_url="$1"

set -eu

if [ ! -d debian ]; then
    echo "Cannot find debian directory from cwd ($(pwd)/debian)"
    exit 1
fi

# Convert package to debian native format.
sed -i s/quilt/native/ debian/source/format

# Remove lines ending with #RMJENKINS
# Used to enable tests
sed -i '/#RMJENKINS\s*$/d' debian/rules

dpkg-buildpackage -us -uc

for deb in ../*.deb; do
    echo "Uploading $deb"
    curl --fail --form "deb=@${deb}" "${debbox_url}/deb"
    echo
done

echo
echo "Packages uploaded to $debbox_url"
echo
