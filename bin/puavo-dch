#!/bin/bash

help(){
    echo "
    Usage: $(basename $0) <version>

    Autogenerate debian/changelog for given version using the current git
    commit.

    If the current git commit contains a string \"!dorelease\" a
    production release style version will be generated.
    "
}

[ "$1" = "--help" -o "$1" = "-h" ] && help && exit 0

version="$1"

set -eu

[ "$version" = "" ] && help && exit 1

if [ ! -d debian ]; then
    echo "Cannot find debian directory from cwd ($(pwd)/debian)"
    exit 1
fi

assert_git_repo()
{
    git rev-parse --git-dir 2>&1 >/dev/null
}

assert_git_repo || {
    echo "E: not a git repository, aborting" >&2
    exit 1
}

if [ -z "${DEBFULLNAME:-}" ]; then
    # Use git commit author name as the release author if no other name is set
    DEBFULLNAME=$(git log -1 --pretty=%an)
fi

if [ -z "${DEBEMAIL:-}" ]; then
    # Also same for the email
    DEBEMAIL=$(git log -1 --pretty=%ae)
fi

# Get ubuntu version to $DISTRIB_CODENAME
. /etc/lsb-release

package_dir=$(pwd)
repo_name=$(basename $(pwd))

# List tags by date
# http://stackoverflow.com/questions/6269927/how-can-i-list-all-tags-in-my-git-repository-by-the-date-they-were-created
git_tags=$(git for-each-ref --sort='*authordate' --format='%(refname:short)' refs/tags)
version_tags=$(echo "$git_tags" | grep --color=never --line-regexp --extended-regexp '^[0-9]+\.[0-9]+\.[0-9]$')
prev_version=$(echo "$version_tags" | tail --lines=1)
git_commit=$(git rev-parse HEAD)
git_commit_msg=$(git log -1 --pretty=%B)
git_branch=$(git rev-parse --abbrev-ref HEAD)

if [ $git_branch = "HEAD" ]; then
    # Were on detached head state in jenkins. Use the variable set by Jenkins.
    git_branch="${GIT_BRANCH:-}"
    if [ $git_branch = "" ]; then
        echo "Failed to determine git branch!"
        exit 1
    fi
fi


version="$version+dev$(date +%s).$git_branch.$git_commit"
[ "$BUILD_NUMBER" != "" ] && version="$version-$BUILD_NUMBER"

cat > debian/changelog <<EOF
$repo_name ($version) $DISTRIB_CODENAME; urgency=low

  * Release from git commit ${git_commit}
  * https://github.com/opinsys/$repo_name/tree/$git_commit
  * https://github.com/opinsys/$repo_name/compare/$prev_version...$git_commit
  * Build on $(uname -a)
  * Jenkins build ${BUILD_TAG:-} ${BUILD_URL:-}

 -- $DEBFULLNAME <$DEBEMAIL>  $(date -R)

EOF
